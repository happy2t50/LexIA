events {
    worker_connections 1024;
}

http {
    # Configuración general
    client_max_body_size 10M;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # ============================================================
    # RATE LIMITING - Protección contra fuerza bruta
    # ============================================================

    # Zona para rate limiting general (10 req/s por IP)
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;

    # Zona para endpoints sensibles de auth (3 req/min por IP)
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=3r/m;

    # Zona para login específicamente (5 intentos en 1 min por IP)
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

    # Zona para chat (20 mensajes por minuto por IP)
    limit_req_zone $binary_remote_addr zone=chat_limit:10m rate=20r/m;

    # Upstream para cada servicio
    upstream auth_service {
        server auth:3003;
    }

    upstream olap_service {
        server olap-cube:3001;
    }

    upstream clustering_service {
        server clustering:3002;
    }

    upstream nlp_service {
        server nlp:3004;
    }

    upstream rag_service {
        server rag:3009;
    }

    upstream chat_service {
        server chat:3010;
    }

    upstream transactions_service {
        server transactions:3005;
    }

    # Servidor principal
    server {
        listen 80;
        server_name localhost;

        # CORS Headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        # Health check del API Gateway (sin rate limit)
        location /health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"OK","service":"LexIA API Gateway"}';
        }

        # ============================================================
        # RUTAS DE SERVICIOS
        # ============================================================

        # Auth Service - Login (rate limit estricto para prevenir fuerza bruta)
        location /api/auth/login {
            # Límite: 5 intentos por minuto, con burst de 2 adicionales
            limit_req zone=login_limit burst=2 nodelay;
            limit_req_status 429;

            proxy_pass http://auth_service/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - Register (rate limit moderado)
        location /api/auth/register {
            # Límite: 3 registros por minuto
            limit_req zone=auth_limit burst=1 nodelay;
            limit_req_status 429;

            proxy_pass http://auth_service/register;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - Recuperación de contraseña (rate limit estricto)
        location /api/auth/forgot-password {
            # Límite: 3 intentos por minuto
            limit_req zone=auth_limit burst=1 nodelay;
            limit_req_status 429;

            proxy_pass http://auth_service/forgot-password;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - Otras rutas (rate limit general)
        location /api/auth/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # OLAP Cube Service
        location /api/olap/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://olap_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Clustering ML Service
        location /api/clustering/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://clustering_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # NLP Service
        location /api/nlp/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://nlp_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # RAG Service
        location /api/rag/ {
            limit_req zone=general_limit burst=15 nodelay;
            limit_req_status 429;

            proxy_pass http://rag_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts más largos para RAG (procesamiento de embeddings)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Chat Service - Message endpoint (rate limit específico)
        location /api/chat/message {
            # Límite: 20 mensajes por minuto con burst de 5
            limit_req zone=chat_limit burst=5 nodelay;
            limit_req_status 429;

            proxy_pass http://chat_service/message;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts más largos para chat (procesamiento completo)
            proxy_connect_timeout 90s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
        }

        # Chat Service - Otras rutas (rate limit general)
        location /api/chat/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://chat_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts más largos para chat (procesamiento completo)
            proxy_connect_timeout 90s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
        }

        # Transactions Service - Webhook endpoint (sin rate limit para Stripe)
        location /api/transactions/webhook/stripe {
            proxy_pass http://transactions_service/webhook/stripe;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Transactions Service - Otras rutas (rate limit general)
        location /api/transactions/ {
            limit_req zone=general_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_pass http://transactions_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Redirección raíz (sin rate limit)
        location / {
            default_type application/json;
            return 200 '{"message":"LexIA 2.0 API Gateway","version":"1.0.0","endpoints":["/api/auth","/api/olap","/api/clustering","/api/nlp","/api/rag","/api/chat","/api/transactions"],"rateLimits":{"login":"5 req/min","register":"3 req/min","chat":"20 msg/min","general":"10 req/s"}}';
        }
    }
}
